<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>FOURTH CONSOLE</title>

<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div id="overlay">
  <div id="overlay-text">SYSTEM ACTIVE</div>
</div>

<div id="frame">
  <div id="header">
    <span>FOURTH CONSOLE</span>
    <span id="phase">PHASE ?</span>
  </div>

  <div id="console"></div>

  <div id="input-line">
    <span class="prompt">❯</span>
    <input id="cmd" autocomplete="off" autofocus>
  </div>
</div>

<script>
const consoleEl = document.getElementById("console");
const input = document.getElementById("cmd");
const phaseEl = document.getElementById("phase");
const overlay = document.getElementById("overlay-text");

function log(text="") {
  consoleEl.textContent += text + "\n";
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

async function send(cmd) {
  document.body.classList.add("flash");
  setTimeout(()=>document.body.classList.remove("flash"),80);

  const res = await fetch("/command", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ cmd })
  });
  return res.json();
}

/* 起動 */
const boot = [
  "BOOT SEQUENCE INITIATED",
  "LOADING CORE MODULES",
  "LINKING OBSERVATION NODE",
  "TERMINAL CONNECTED"
];

async function bootSequence() {
  for (const line of boot) {
    log(line);
    await new Promise(r => setTimeout(r, 500));
  }
  log("");
  log("INPUT COMMAND");
}
bootSequence();

input.addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  const cmd = input.value.trim();
  if (!cmd) return;

  log("❯ " + cmd);
  input.value = "";

  overlay.textContent = "PROCESSING...";
  overlay.classList.add("active");

  await new Promise(r => setTimeout(r, 300));

  const data = await send(cmd);
  overlay.classList.remove("active");

  log(data.output);

  if (cmd === "status" && data.output.includes("PHASE")) {
    phaseEl.textContent = data.output;
  }

  if (data.notice) {
    overlay.textContent = "SYSTEM NOTICE";
    overlay.classList.add("alert");
    setTimeout(()=>overlay.classList.remove("alert"),1200);

    log("");
    log("=== NOTICE ===");
    log(data.notice);
    log("");
  }
});
</script>
</body>
</html>
