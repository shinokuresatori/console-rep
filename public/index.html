<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Console -Complicate-</title>

<!-- フォント -->
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div id="frame">
  <div id="header">
    <span>console</span>
    <span id="phase">PHASE ?</span>
  </div>

  <div id="console"></div>

  <div id="input-line">
    <span>&gt;</span>
    <input id="cmd" autocomplete="off" autofocus>
  </div>
</div>

<script>
const consoleEl = document.getElementById("console");
const input = document.getElementById("cmd");
const phaseEl = document.getElementById("phase");

function log(text = "") {
  consoleEl.textContent += text + "\n";
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

async function send(cmd) {
  document.body.classList.add("flash");
  setTimeout(()=>document.body.classList.remove("flash"),60);

  const res = await fetch("/command", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ cmd })
  });
  return res.json();
}

// 起動演出
const boot = [
  "INITIALIZING TERMINAL...",
  "CHECKING INTEGRITY...",
  "ESTABLISHING CONNECTION...",
  "TERMINAL ONLINE"
];

async function bootSequence() {
  for (const line of boot) {
    log(line);
    await new Promise(r => setTimeout(r, 450));
  }
  log("");
  log("TYPE 'help' TO BEGIN");
}
bootSequence();

input.addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  const cmd = input.value.trim();
  if (!cmd) return;

  log("> " + cmd);
  input.value = "";

  const data = await send(cmd);
  log(data.output);

  // PHASE 表示更新
  if (cmd === "status" && data.output.includes("PHASE")) {
    phaseEl.textContent = data.output;
  }

  // NOTICE 表示
  if (data.notice) {
    log("");
    log("=== SYSTEM NOTICE ===");
    log(data.notice);
    log("");
  }
});
</script>
</body>
</html>
